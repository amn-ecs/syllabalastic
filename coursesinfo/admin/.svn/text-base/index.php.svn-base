<?php
error_reporting(E_ALL );
ini_set('display_errors',1 );


require_once('include.php');
require_once "ECS/utils.php";
require_once "ECS/courses.php";

renderHeader();
	
$session = "1213";	
if( @$_GET["session"] ) { $session= preg_replace( '/[^0-9]/','',$_GET["session"] ); }

$session = COURSES_GetSession();
$prev = COURSES_getSessionBefore($session);
$next = COURSES_getSessionAfter($session);
print "<p>View: ";
print "<a href='?session=$prev'>".COURSES_SessionName( $prev )."</a> | ";
print "<strong>".COURSES_SessionName( $session )."</strong> | ";
print "<a href='?session=$next'>".COURSES_SessionName( $next )."</a>";
print "</p>";

print "<p>List of all modules and draft modules in the ".COURSES_SessionName( $session )." session.</p>";

$session += 0; # double check it's just a number.

$modules = array();

# yikes, raw SQL


# first get all the provisional data for the session (we delete
# this in a moment if there's a proper value set in NEWSYL_UNIT_SESSION
$sql = "
SELECT 
	syllabus_id,
	provisional_code,
	provisional_semester,
	provisional_notes,
	provisional_title
FROM 
	NEWSYL_MAIN
WHERE 
	provisional_session = '$session' 
";
$rows = ECS_queryFetchFree($sql);

$prov_code_count = 0;
foreach( $rows as $row )
{
	foreach( $row as $k=>$v ) { $row[$k] = trim( $row[$k] ); }
	$unit_code = $row["provisional_code"];
	if( $unit_code == "" ) 
	{ 
		$unit_code = sprintf( "XXXX%04d", $prov_code_count++ );
	}
	$course_code = substr( $unit_code, 0, 4 );
	$yos = substr( $unit_code, 4, 1 );
	$modules[ $course_code ][ $yos ][ $unit_code ] = $row;
}




$sql = "
SELECT DISTINCT 
	DEGS.Faculty_Unit_code as code,
	UNITLIST.TITLE as title,
	UNITLIST.Semester1 as semester_1,
	UNITLIST.Semester2 as semester_2, 
	UNITLIST.Show_Code as show_code
FROM DEGS, UNITLIST 
WHERE 
	UNITLIST.SESSION = '$session' 
	AND DEGS.SESSION = '$session' 
	AND DEGS.UNIT = UNITLIST.UNIT 
";

$rows = ECS_queryFetchFree($sql);
foreach( $rows as $row )
{
	foreach( $row as $k=>$v ) { $row[$k] = trim( $row[$k] ); }
	$unit_code = $row["code"];
	if( $unit_code == "" ) { continue; }

	$course_code = substr( $unit_code, 0, 4 );
	$yos = substr( $unit_code, 4, 1 );
	$modules[ $course_code ][ $yos ][ $unit_code ] = $row;
}

# add syllabus ID if known
$sql = "
SELECT 
	syllabus_id, 
	code
FROM 
	NEWSYL_UNIT_SESSION
WHERE 
	session = '$session' 
";
$rows = ECS_queryFetchFree($sql);
foreach( $rows as $row )
{
	foreach( $row as $k=>$v ) { $row[$k] = trim( $row[$k] ); }
	$unit_code = $row["code"];
	if( $unit_code == "" ) { continue; }

	$course_code = substr( $unit_code, 0, 4 );
	$yos = substr( $unit_code, 4, 1 );
	$modules[ $course_code ][ $yos ][ $unit_code ]["syllabus_id"] = $row["syllabus_id"];
	$modules[ $course_code ][ $yos ][ $unit_code ]["code"] = $row["code"];
}

ksort( $modules );
print "<ul>";
foreach( $modules as $course_code => $yos_list )
{
	print "<li>$course_code<ul>";
	ksort( $yos_list );
	foreach( $yos_list as $yos => $module_list )
	{
		print "<li>$course_code$yos...<ul>";
		ksort( $module_list );
		foreach( $module_list as $module )
		{
			#print "<li>".ECS_Dumper( $module )."</li>";
			print "<li>";
			if( isset( $module["code"] )) 
			{
				print "<strong>".htmlspecialchars($module["code"]).":</strong> ";
			}
			else
			{
				print "<strong>*no code*</strong> ";
			}
			if( isset( $module["title"] )) 
			{ 
				print htmlspecialchars($module["title"]); 
			}
			elseif( isset( $module["provisional_title"] )) 
			{ 
				print htmlspecialchars($module["provisional_title"])." (provisional)"; 
			}
			if( isset( $module["syllabus_id"] ) )
			{
				print " [<a href='syl-edit.php?id=".$module["syllabus_id"]."'>Edit Information</a>]";
			}
			else
			{
				print " [Create provisional course information] *feature not yet available*";
			}
			print "</li>";
		}
		print "</ul></li>";
	}
	print "</ul></li>";
}
print "</ul>";
#print ECS_dumper( $modules );


renderFooter();


exit;


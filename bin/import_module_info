#!/usr/bin/php
<?php
$path_to_base_dir = "../"; 
require_once($path_to_base_dir.'includes.php');

if (count($argv) < 2)
{
	echo "you must specifiy a file to import\n";
	exit;
}
$file = fopen( $argv[1], "r" ) or die("file does not exist");
$info = array();

fgets($file); # chuck the headings away

while( $line = fgets($file) )
{
	$line = explode("|", $line);
	if(!is_array($line) or count($line) < 10){ print("Something is wrong this line has no data\n"); continue; }
	####### TODO, reading the data file should be abstracted, this is blatently something which will change
	$info[$line[0]][$line[10]]["title"] = $line[44];
	$info[$line[0]][$line[10]]["departmentcode"] = $line[6];
	$info[$line[0]][$line[10]]["departmentname"] = $line[7];
	$info[$line[0]][$line[10]]["facultycode"] = $line[4];
	$info[$line[0]][$line[10]]["facultyname"] = $line[5];
	$info[$line[0]][$line[10]]["semestercode"] = $line[17];
	$info[$line[0]][$line[10]]["semestername"] = $line[18];
	$info[$line[0]][$line[10]]["levelcode"] = $line[35];
	$info[$line[0]][$line[10]]["credits"] = $line[19];
	if($staff_id = trim($line[29]))
	{
		$info[$line[0]][$line[10]]["people"][$staff_id] = 1;
		$people[$staff_id]["first_name"] = trim($line[31]);
		$people[$staff_id]["last_name"] = trim($line[30]);
	}

	if($program_code = trim($line[36]))
	{
		$programs[$program_code]["title"] = $line[37];
		$programs[$program_code]["majors"][$line[38]] = 1;
	}
	if($major_code = trim($line[38]))
	{
		# 10 - course_code
		# 40 - year_of_study
		# 43 - module_type
		# 38 = major_code
		# 39 = major_desc (title)
		# 0 = session
		$majors[$line[0]][$major_code]["title"] = $line[39];
		$majors[$line[0]][$major_code]["modules"][$line[10]] = array(
			"yearofstudy"=>$line[40],
			"type"=>$line[43] );
	}
}

print "People import\n";
foreach( $people as $staff_id => $people_properties )
{
	$person = R::findOne("person", "staffid = ?", array( $staff_id ) );
	if(!isset($person))
	{
		$person = R::dispense("person");
		$person->staffid = $staff_id;
	}
#always update staff name for cases of name change in data. This could be optimized if necessary.
	$person->firstname = $people[$staff_id]["first_name"];
	$person->lastname = $people[$staff_id]["last_name"];
	
	R::store($person);
}

$module_beans = array();
print "Modules import\n";
foreach( $info as $session => $modules)
{
	foreach($modules as $module_code => $properties )
	{
		$module = R::findOne("module", "session = ? AND code = ?", array( $session, $module_code ) );
		
		if(!isset($module)){
			$module = R::dispense('module');
			$module->code = $module_code;
			$module->session = $session;
		}

		$module->title = $properties["title"];
		$module->facultycode = $properties["facultycode"];
		$module->facultyname = $properties["facultyname"];
		$module->semestercode = $properties["semestercode"];
		$module->semestername = $properties["semestername"];
		$module->departmentcode = $properties["departmentcode"];
		$module->departmentname = $properties["departmentname"];
		$module->levelcode = $properties["levelcode"];
		$module->credits = $properties["credits"];
		if( !empty($properties["people"]) )
		{	
			$people = array_keys($properties["people"]);
			$module->sharedPerson = R::find('person', ' staffid IN ('.R::genSlots($people).') ', $people);
		}
		R::store($module);

		$module_beans[$session][$module_code] = $module;
	}
	
}


R::wipe( "modulemajorrelation" );

print "Majors import\n";
foreach( $majors as $session=>$session_majors )
{
	foreach( $session_majors as $major_code => $major_properties )
	{
		$major = R::findOne("major", "code = ? AND session = ?", array($major_code,$session ) );
	
		if(!isset($major))
		{
			$major = R::dispense('major');
			$major->code = $major_code;
			$major->session = $session;
		}
	
		$major->title = $major_properties["title"];

		R::store($major);

		if( !empty($major_properties["modules"]) )
		{
			foreach( $major_properties["modules"] as $module_code=>$rel_info )
			{
				$module = $module_beans[$session][$module_code];
				$relation = R::dispense('modulemajorrelation');
				$relation->session = $session; # not strictly needed
				$relation->yearofstudy = $rel_info["yearofstudy"];
				$relation->type = $rel_info["type"];
				$relation->module = $module;
				$relation->major = $major;
				R::store( $relation );
			}
				
		}
	}
}

#!!!!!!!!!!!!!
exit;

print "Programs import\n";
foreach($programs as $program_code => $program_properties){

	$program = R::findOne("program", "code = ?", array($program_code ) );
	
	if(!isset($program))
	{
		$program = R::dispense('program');	
		$program->code = $program_code;
	}

	$program->title = $program_properties["title"];

	if( !empty($program_properties["majors"]) )
	{
		$majors = array_keys($program_properties["majors"]);
		$program->sharedMajor = R::find('major', ' code IN ('.R::genSlots($majors).') ', $majors);
	}

	R::store($program);
}


		
	


?>
